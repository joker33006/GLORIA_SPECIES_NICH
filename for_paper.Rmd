---
title: "GLORIA second stage_Diversity and niche"
output: html_notebook
---
## 前述
這是GLORIA第二階段發表的paper試驗
主軸在更細緻的討論樣區的物種多樣性在不同時期的變化以及消失、出現的物種特性。
研究問題：
1. 在各山峰細緻的生物多樣性表現出怎樣的格局?是否跟溫度或其他環境因子有關?
2. 在第一篇報告中，我們發現有溫度上升的事實。那增加的物種與覆蓋度擴大的物種是否與溫度上升有關?那消失的物種呢?

## 分析測試
### package 載入
分析使用到的package集中處
```{r echo=FALSE}
library(data.table) #for data loading and 
library(vegan) # for the vegetation analysis(which like diversity and multiple variable analysis)
library(ggplot2)
library(ggpubr)
library(agricolae)#for HSD test
library(tidyverse) #pipe
library(rstatix) #for Repeated Measures ANOVA and post-hoc tests
library(patchwork) #arrange
library(broom)
```
### 基礎資料載入
載入三項基礎資料，分別為2008-2020的section plot 調查資料、section plot 的環境資料以及日均溫與降雨量資料
```{r echo=FALSE}
r_sp_sec <-fread('Surveydata_and_niche/2008_2020_DAS_SYU_p5p10_BBq.csv')
r_sp_11 <- fread('Surveydata_and_niche/SYU_DAS_1X1_total.csv')
###2008-2020,DAS and SYU, P5m P10m 
r_env <- fread('Surveydata_and_niche/2008_2020_DAS_SYU_p5p10_plot_env.csv')# plot environment data table
r_wth <- fread('Weather_data/temp_combin_daily.csv')#daily temperature and precipitation data
svpath <- "G:/我的雲端硬碟/GLORIA_個人處理/paper_準備/SYU_DAS_water/result"
```

### 氣候與物種增關係
**核心概念:時間** 
在氣候變化的條件下，各山峰物種的區位組成是如何變化?覆蓋增減的物種屬於何種類型?
Step 1. 基礎資料載入
```{r}
bio_nich <- fread('Surveydata_and_niche/bio_niche.csv')
wi_nich <- fread('Surveydata_and_niche/WI_niche.csv')
name_list <- fread("Surveydata_and_niche/name_list.csv")
code_ref <- name_list[,.(code,GBIF_code)]
nich <- bio_nich[wi_nich,on=.(code=code)]
nich <- nich[code_ref,on=.(code=GBIF_code)]#將所有氣候區位資料結合
nich[,i.V1:=NULL]
setnames(x = r_sp_sec,old =c("Target region code","Summit code","方位","Sunnit area section","coverage"),new=c("region","Summit","dir","Summit_dir","cov"))
r_data <- dcast(r_sp_sec,region+Summit+dir+Summit_dir+Name+code~Period,value.var = c('cov',"r_cov"),fun=sum)#r_data為不同時期之物種覆蓋度整理
```
資料說明
r_data: 統整三個時期各山峰樣區p5m_p10m的植物覆蓋相對值與絕對值
nich: 氣候區位bio_1(年均溫),bio_12(年降雨量),數字1-5為溫量指數,table中的code是GBIF下載之順序

Step 2. 結合raw data與物種niche
```{r}
sec_r <- r_sp_sec[nich,on=.(code=i.code.1)] #計算各時期物種頻度用
sec_r <- sec_r[!is.na(year)]#section樣區資料
setnames(r_sp_11,c("%-cover"),c("cov"))
x11_r <- r_sp_11[nich,on=.(code=i.code.1)]#1X1樣區資料
```

Step 3. 計算樣區的嗜熱指數與嗜濕指數
分別計算1X1樣區的嗜熱指數以及section的嗜熱指數
step 3.1 section
```{r}
####計算各樣區的指標
sec_r[,r_heat:=cov*bio_1_3][,r_pre:=cov*bio_12_3]
trend_ind <-sec_r[,.(heat_ind=sum(r_heat)/sum(cov),pre_ind=sum(r_pre)/sum(cov)),by=.(region,Summit,dir,Summit_dir,Period)]
trend_ind[,Summit:=as.factor(Summit)][,Period:=as.factor(Period)]
fwrite(trend_ind,"ind_caculate.csv")
fwrite(sec_r,"SYU_DAS_section_and_niche_data.csv")
#######################球形檢定
shapi_t_r <- trend_ind %>%
  group_by(Summit,Period) %>%
  shapiro_test(heat_ind)
r <- trend_ind %>%
  group_by(Summit,Period) %>%
  shapiro_test(pre_ind)
shapi_t_r <- rbind(shapi_t_r,r)
fwrite(shapi_t_r,paste0(svpath,"/Normality_Test_for_heat_mosi_ind.csv"))
ggqqplot(trend_ind, "heat_ind", ggtheme = theme_bw()) +
  facet_grid(Summit ~ Period)
ggsave(paste0(svpath,"/plot/Thermo_qqplot.jpeg"),width = 8,height = 15,dpi=600)
ggqqplot(trend_ind, "pre_ind", ggtheme = theme_bw()) +
  facet_grid(Summit ~ Period)
ggsave(paste0(svpath,"/plot/moist_qqplot.jpeg"),width = 8,height = 15,dpi=600)
####################計算調查間差值
dif <-dcast(trend_ind,region+Summit+dir+Summit_dir~Period,value.var=c("heat_ind","pre_ind"))
dif[,h_p12:=heat_ind_P2-heat_ind_P1][
  ,h_p23:=heat_ind_P3-heat_ind_P2][
    ,p_p12:=pre_ind_P2-pre_ind_P1][
      ,p_p23:=pre_ind_P3-pre_ind_P2]
t.test_total_r <- NULL
for (j in c('h_p12','h_p23','p_p12','p_p23')){
for (i in c('SEN','SUN','YAT','DSH','JNJ','TSW')){
  ttest_r <- t.test(dif[Summit==i,j,with=FALSE],mu=0)
  r <- data.table(variable=j,Summit=i,
                  t=ttest_r$statistic,
                  df=ttest_r$parameter,
                  p_value=ttest_r$p.value)
  t.test_total_r <- rbind(t.test_total_r,r)}
}
fwrite(t.test_total_r,paste0(svpath,"/t_test_of_ind_dif_with_zero.csv"))
dif[,Summit:=factor(Summit,levels= c('SEN','SUN','YAT','TSW','DSH','JNJ'))]
t.test_total_r[p_value<0.05,sign:="*"]
t_r <- dcast(t.test_total_r,Summit~variable)

t_r <- t_r[dif[,lapply(.SD,max),by=Summit,.SDcols=11:14],on=.(Summit=Summit)]
t_r[,Summit:=factor(Summit,levels= c('SEN','YAT','SUN','TSW','DSH',"JNJ"))]
############
w=0.4
for (i in 1:4){
var <- c("h_p12","h_p23","p_p12","p_p23")
ind <- c("Thermophilization indicator","moist-philization indicator")
pos <- c(1,60)
ggplot(dif,aes(x=Summit,y=get(var[i]),fill=Summit))+
   geom_boxplot(width=w)+
  scale_fill_brewer(palette = 'Set2')+
  theme_classic()+
  geom_text(data=t_r, aes(x=Summit,y=get(paste0("i.",var[i]))+pos[ceiling(i/2)], label=get(var[i])))+
   labs(x="Summit",y=ind[ceiling(i/2)],title=paste0("(",letters[i],")"))+
  theme(legend.position = "None")+
  scale_x_discrete(limits= c('SEN','YAT','SUN','TSW','DSH',"JNJ"))+
  geom_hline(yintercept=0,linetype="dotted",colour="#BB0000")
ggsave(paste0(svpath,"/plot/",ind[ceiling(i/2)],"_",var[i],".jpeg"),width = 4,height = 3,dpi=600)
}
```
step 3.2 1x1 #拋棄不用

```{r}
setnames(x11_r,c("Target region code","Summit code"),c("region","summit"))
x11_r <- x11_r[!is.na(period)]
x11_r[,r_heat:=cov*bio_1_3][,r_pre:=cov*bio_12_3]
x11_r[,Summit_dir:=paste0(summit,"_",`Quadrat code`)]
ind_r <-x11_r[,.(heat_ind=sum(r_heat)/sum(cov),pre_ind=sum(r_pre)/sum(cov)),by=.(region,summit,Dir,Summit_dir,period)]
x11_dif <-dcast(ind_r,region+summit+Dir+Summit_dir~period,value.var=c("heat_ind","pre_ind"))
x11_dif[,h_p12:=heat_ind_2-heat_ind_1][
  ,h_p23:=heat_ind_3-heat_ind_2][
    ,p_p12:=pre_ind_2-pre_ind_1][
      ,p_p23:=pre_ind_3-pre_ind_2]
############# t test with Zero
t.test_total_r <- NULL
for (j in c('h_p12','h_p23','p_p12','p_p23')){
for (i in c('SEN','SUN','YAT','DSH','JNJ','TSW')){
  ttest_r <- t.test(x11_dif[summit==i,j,with=FALSE],mu=0)
  r <- data.table(variable=j,Summit=i,
                  t=ttest_r$statistic,
                  df=ttest_r$parameter,
                  p_value=ttest_r$p.value)
  t.test_total_r <- rbind(t.test_total_r,r)}
}
fwrite(t.test_total_r,paste0(svpath,"/x11_t_test_of_ind_dif_with_zero.csv"))
dif[,Summit:=factor(Summit,levels= c('SEN','SUN','YAT','TSW','DSH','JNJ'))]
t.test_total_r[p_value<0.05,sign:="*"]
t_r <- dcast(t.test_total_r,Summit~variable)

t_r <- t_r[dif[,lapply(.SD,max),by=Summit,.SDcols=11:14],on=.(Summit=Summit)]
t_r[,Summit:=factor(Summit,levels= c('SEN','YAT','SUN','TSW','DSH',"JNJ"))]

w=0.4
for (i in 1:4){
var <- c("h_p12","h_p23","p_p12","p_p23")
ind <- c("Thermophilization indicator","moist-philization indicator")
pos <- c(1,60)
ggplot(x11_dif,aes(x=summit,y=get(var[i]),fill=summit))+
   geom_boxplot(width=w)+
  scale_fill_brewer(palette = 'Set2')+
  theme_classic()+
  geom_text(data=t_r, aes(x=Summit,y=get(paste0("i.",var[i]))+pos[ceiling(i/2)], label=get(var[i])))+
   labs(x="Summit",y=ind[ceiling(i/2)],title=paste0("(",letters[i],")"))+
  theme(legend.position = "None")+
  scale_x_discrete(limits= c('SEN','YAT','SUN','TSW','DSH',"JNJ"))+
  geom_hline(yintercept=0,linetype="dotted",colour="#BB0000")
ggsave(paste0(svpath,"/plot/x11_",ind[ceiling(i/2)],"_",var[i],".jpeg"),width = 4,height = 3,dpi=600)
}

```



Step 4. 以山峰為主體做嗜熱與嗜濕指數分析
```{r}
n_ind_avg <- nich_ind[,.(h_ind=mean(heat_ind),h_ind_sd=sd(heat_ind),p_ind=mean(pre_ind),p_ind_sd=sd(pre_ind)),by=.(region,Summit,period)]

aov_cls <- function(x){
  c_r <- NULL
  for (i in c('SEN','SUN','YAT','DSH','JNJ','TSW')){
    t_aov <- aov(get(x)~period,data=nich_ind[Summit==i])
    tuk <- HSD.test(t_aov,'period', alpha = 0.05)
    cls <- as.data.table(cbind(data.table(summit=i,period=rownames(tuk$groups),tuk$group)))
    c_r <- rbind(c_r,cls)
    }
  return(c_r)}

n_ind_avg <- n_ind_avg[aov_cls('heat_ind'),on=.(Summit=summit,period=period)]  
setnames(n_ind_avg,'groups','t_groups')
n_ind_avg <- n_ind_avg[aov_cls('pre_ind'),on=.(Summit=summit,period=period)]
setnames(n_ind_avg,'groups','p_groups')
####plot 
w=0.8
ggplot(n_ind_avg,aes(x=Summit,y=h_ind, fill=period))+
  geom_bar(stat="identity", position=position_dodge(),width = w)+
  geom_errorbar(aes(ymin=h_ind-h_ind_sd, ymax=h_ind+h_ind_sd), 
                position = position_dodge(width =w),width = 0.2)+
  theme_classic2()+
  geom_text(aes(label=t_groups, group=period),
            position=position_dodge(width=w),vjust=-3)+
  scale_x_discrete(limits=c("TSW","SEN","DSH","YAT","JNJ",'SUN'))+
  scale_fill_brewer(palette = 'Set2')+
  labs(x="Summit",y="Thermophilic index")+
  ylim(c(0,14))
ggsave("plot/Thermo_indexXSummit.jpeg",width=6,height=3,dpi=600)  

ggplot(n_ind_avg,aes(x=Summit,y=p_ind, fill=period))+
  geom_bar(stat="identity", position=position_dodge(),width = w)+
  geom_errorbar(aes(ymin=p_ind-p_ind_sd, ymax=p_ind+p_ind_sd), 
                position = position_dodge(width =w),width = 0.2)+
  theme_classic2()+
  geom_text(aes(label=p_groups, group=period),
            position=position_dodge(width=w),vjust=-3)+
  scale_x_discrete(limits=c("TSW","SEN","DSH","YAT","JNJ",'SUN'))+
  scale_fill_brewer(palette = 'Set2')+
  labs(x="Summit",y="Moist-philic index")+
  ylim(c(0,2400))
ggsave("plot/Moist_indexXSummit.jpeg",width=6,height=3,dpi=600) 

```



step 7 物種數增減
```{r}
input <- fread("SYU_DAS_section_and_niche_data.csv")
base_clim <- fread(paste0(svpath,"/Summit_basic.csv"))
input[,bio_1_r:=bio_1_4-bio_1_2][,bio_12_r:=bio_12_4-bio_12_2]
spe_in_S <- input[,.(r_cov=sum(r_cov)),by=.(Period,region,Summit,Name,code,bio_1_3,bio_12_3,bio_1_r,bio_12_r)]
#以山峰為單位計算物種增減
spe_in_S[r_cov>0,count:=1]
spe_count <- dcast(spe_in_S,region+Summit+Name+code+bio_1_3+bio_12_3+bio_1_r+bio_12_r~Period,
                   value.var = c("r_cov","count"),fill = 0)
spe_count[,cov_12:=r_cov_P2-r_cov_P1][
  ,cov_23:=r_cov_P3-r_cov_P2][,cou_12:=count_P2-count_P1][,
    cou_23:=count_P3-count_P2]
stat_ad <- merge(merge(spe_count[cou_12>0,.(add_12=sum(cou_12)),by=.(Summit)],
      spe_count[cou_12<0,.(dis_12=-sum(cou_12)),by=.(Summit)],on=.(Summit=Summit),all=TRUE),
      merge(spe_count[cou_23>0,.(add_23=sum(cou_23)),by=.(Summit)],
      spe_count[cou_23<0,.(dis_23=-sum(cou_23)),by=.(Summit)],on=.(Summit=Summit)),
      on=.(Summit=Summit))
stat_ad <- stat_ad[base_clim,on=.(Summit=Summit)]
stat_ad[,10:14] <- NULL
stat_ad[is.na(add_12),add_12:=0]
colnames(stat_ad)
f_pr <- NULL
for(i in c("add_12","dis_12","add_23","dis_23")){
  for (j in c("avg_t2","avg_p","alt")){
      pr <- with(stat_ad,{
     cor.test(get(i), get(j), method = c("pearson"))})
  ppr <- data.table(var=i,clim=j, t=pr$statistic,cor=pr$estimate,pvalue=pr$p.value)
  f_pr <- rbind(f_pr,ppr)
  }
}
fwrite(f_pr,paste0(svpath,"correlation_clim_spe_n_var.csv"))

```
step 8 物種覆蓋增減與氣候區位

```{r}
fwrite(spe_count,paste0(svpath,"spc_cov_var_r_data.csv"))
cov_ch <- fread(paste0(svpath,"spc_cov_var_r_data.csv"))
cov_ch[cov_12>0,cag_12:="extension"][cov_12<0,cag_12:="reduction"][
  cov_23>0,cag_23:="extension"][cov_23<0,cag_23:="reduction"]
cov_ch[,o_cov_12:=cov_12][,o_cov_23:=cov_23]
cov_ch[,cov12_r:=(r_cov_P2+1)/(r_cov_P1+1)][,cov23_r:=(r_cov_P3+1)/(r_cov_P2+1)]
cov_ch[cov_12<0,cov_12:=cov_12*-1]
cov_ch[cov_23<0,cov_23:=cov_23*-1]
cov_ch[is.na(cag_12),cag_12:="0"]
cov_ch[is.na(cag_23),cag_23:="0"]
cov_ch[,Summit:=factor(Summit,levels = c("SEN","YAT","SUN","TSW","DSH","JNJ"))]
############### normalize test of cov change 
shapiro_test(cov_ch,cov12_r)
ggplot(data=cov_ch,aes(x=cov12_r))+
  geom_density(kernel = "gaussian")


###########################333
m1 <- glm(cov12_r~bio_1_3+bio_12_3+bio_1_r+bio_12_r,
          data=cov_ch[!cov12_r==1],family=Gamma(link = "log"))
glance(m1)
##################

ggplot(cov_ch[region=="DAS"],aes(x=bio_1_3,y=bio_12_3))+
  geom_point(aes(color = cag_12, size = cov_12), alpha = 0.5,na.rm = TRUE)+
  facet_grid(~Summit)+
  labs(x="precipitation niche (mm)",y="temperature niche (°C)",color="Alter",size="DC")

DAS_pr <- ggplot(cov_ch[region=="DAS"],aes(x=bio_1_r,y=bio_12_r))+
  geom_point(aes(color = cag_12, size = cov_12), alpha = 0.5,na.rm = TRUE)+
  facet_grid(~Summit)+
  labs(x="precipitation niche (mm)",y="temperature niche (°C)",color="Alter",size="DC")
SYU_pr <- ggplot(cov_ch[region=="SYU"],aes(x=bio_1_r,y=bio_12_r))+
  geom_point(aes(color = cag_12, size = cov_12), alpha = 0.5,na.rm = TRUE)+
  facet_grid(~Summit)+
  labs(x="precipitation niche (mm)",y="temperature niche (°C)",color="Alter",size="DC") 
DAS_pr+SYU_pr+ plot_layout(ncol = 1, guides = "collect")
  
```

