---
title: "GLORIA second stage_Diversity and niche"
output: html_notebook
---
## 前述
這是GLORIA第二階段發表的paper試驗
主軸在更細緻的討論樣區的物種多樣性在不同時期的變化以及消失、出現的物種特性。
研究問題：
1. 在各山峰細緻的生物多樣性表現出怎樣的格局?是否跟溫度或其他環境因子有關?
2. 在第一篇報告中，我們發現有溫度上升的事實。那增加的物種與覆蓋度擴大的物種是否與溫度上升有關?那消失的物種呢?
## 研究目的
1. 討論六座山峰中各方位樣區alpha多樣性與Beta多樣性
2. 六座山峰的多樣性變化趨勢與氣候變化趨勢
3. 討論消失與出現物種的氣候區位與生活型
4. 植群氣候區位組成是否反映了氣候變化型態

## 分析測試
### package 載入
分析使用到的package集中處
```{r echo=FALSE}
library(data.table) #for data loading and 
library(vegan) # for the vegetation analysis(which like diversity and multiple variable analysis)
library(ggplot2)
library(ggvegan)
```

### 基礎資料載入
載入三項基礎資料，分別為2008-2020的section plot 調查資料、section plot 的環境資料以及日均溫與降雨量資料
```{r echo=FALSE}
setwd('E:/Git_R_work/GLORIA_SPECIES_NICH/')
r_sp <-fread('Surveydata_and_niche/2008_2020_DAS_SYU_p5p10_BBq.csv')###2008-2020,DAS and SYU, P5m P10m 
r_env <- fread('Surveydata_and_niche/2008_2020_DAS_SYU_p5p10_plot_env.csv')# plot environment data table
r_wth <- fread('Weather_data/temp_combin_daily.csv')#daily temperature and precipitation data
```
### Test 1
**核心概念(空間)**
在單一時間尺度下，以各山峰樣區為單位，他的Alpha 多樣性與Beta多樣性會是如何?
#### 方法
試著使用單一維度(多樣性指數)與多維度(CA)的方式來探討
step 1. 基本資料處理

```{r echo=FALSE}

colnames(r_sp)
r_sp[,pcode:=paste0(`Summit code`,'-',`Sunnit area section`)]
r_sp[year %in% 2008:2009,period:='P1'][
  year %in% 2013:2014,period:='P2'][
  year %in% 2019:2020,period:="P3"
  ]
sp_p1 <- dcast(r_sp,year+pcode+period ~ code,
value.var = 'cover',sum)
div <- data.table(sp_p1[,1:3],H=diversity(sp_p1[,4:ncol(sp_p1)]),N=specnumber(sp_p1[,4:ncol(sp_p1)]))
div[,summit:=gsub('-[A-Z]{1}.*','',pcode)][
  ,div_plot:=gsub('^[A-Z]{1,3}-','',pcode)]
div[,dir:=gsub('\\d+','',div_plot)][,alt:=gsub("^[A-Z]","",div_plot)]
# div:各山峰樣區物種數與Shannon指數,並建立細部的分組因子
```
Step 2. 處理氣候資料
```{r echo=FALSE}
r_wth[,year:=year(date)]
r_wth[year %in%2008:2012&region=='DAS',w_period:="P2"][year %in%2009:2013&region=='SYU',w_period:="P2"][year %in%2013:2018&region=='DAS',w_period:="P3"][year %in%2014:2019&region=='SYU',w_period:="P3"]
r_avg <- cbind(r_wth[,.(temp_all=mean(temp)),by=.(region,summit,direction)],
            r_wth[w_period=='P2',.(temp_p2=mean(temp)),by=.(region,summit,direction)][,temp_p2],
            r_wth[w_period=='P3',.(temp_p3=mean(temp)),by=.(region,summit,direction)][,temp_p3])

setnames(r_avg,c('V2','V3'),c('t_p2','t_p3'))
avg <- r_avg[,.(temp=mean(temp_all)),by=.(summit,direction)]
avg[order(temp)]
```
div:各山峰樣區的植物多樣性資料(N, shannon)
sp_p1:各山峰樣區的樣區X物種矩陣(數值為相對值)
r_avg:各山峰不同方位的平均溫、與時期均溫，P2(DAS:2008-2012,SYU:2009-2013)，P3(DAS:2013-2018,SYU:2014-2019)
Step 3. 初步繪圖
```{r echo=FALSE}
div_w <- div[r_avg,on=.(summit=summit,dir=direction)]
ggplot(data=div_w,aes(x=summit,y=N,color=alt))+
  geom_point()+
  theme_bw()+
  facet_grid(period~dir)+
  scale_x_discrete(limits=c("TSW","SEN","DSH","YAT","JNJ",'SUN'))
ggsave('plot/diversity_NXP.jpeg',width = 9,height = 6,dpi = 300)

ggplot(data=div_w,aes(x=summit,y=H,color=alt))+
  geom_point()+
  theme_bw()+
  facet_grid(period~dir)+
  scale_x_discrete(limits=c("TSW","SEN","DSH","YAT","JNJ",'SUN'))
ggsave('plot/diversity_HXP.jpeg',width = 9,height = 6,dpi = 300)


ggplot(data=div_w[alt=='10'],aes(x=temp_all,y=N,color=summit))+
  geom_point()+
  theme_bw()+
  facet_grid(period~.)+
  ylim(0,50)+
  smooth_line(y~x)
ggsave('plot/diversity_NXTXP10m.jpeg',width = 8,height = 6,dpi = 300)
```
Step 4. 多變量分析
嘗試使用ca檢視植群組成
```{r}
cca1 <- cca(sp_p1[,4:ncol(sp_p1)])
cca_r <- cbind(sp_p1[,1:3],cca1$CA$u)
cca_r[,summit:=gsub('-[A-Z].*',"",pcode)]
cca_r[,summit_per:=paste0(summit,"_",period)]
ggplot(cca_r,aes(x=CA1,y=CA2,color=summit))+
  geom_point()+
  facet_grid(period~.)

```
嘗試使用pca檢視植群組成
```{r}
rda1 <- rda(sp_p1[,4:ncol(sp_p1)])

rda_r <- cbind(sp_p1[,1:3],rda1$CA$u)
rda_r[,summit:=gsub('-[A-Z].*',"",pcode)][,dir_alt:=gsub('^[A-Z]{1,3}-',"",pcode)]
rda_r[,summit_per:=paste0(summit,"_",period)]
ggplot(rda_r,aes(x=PC1,y=PC2,color=summit,label = pcode))+
  geom_point()+
  geom_text(check_overlap = TRUE)

sum(rda1$CA$eig[1:3])/rda1$tot.chi
```
嘗試使用cca檢視植群組成
```{r}
cca1 <- cca(sp_p1[,4:ncol(sp_p1)])
cca_r <- cbind(sp_p1[,1:3],cca1$CA$u)
cca_r[,summit:=gsub('-[A-Z].*',"",pcode)]
cca_r[,summit_per:=paste0(summit,"_",period)]
ggplot(cca_r,aes(x=CA1,y=CA2,color=summit))+
  geom_point()+
  facet_grid(period~.)

```
